{% extends "base.html" %}
{% block title %}System Preferences{% endblock %}
{% block content %}
<h1>System Preferences</h1>

<div class="section-tabs" data-group="prefs">
    <button class="active" data-tab="seasons" onclick="showTab('prefs', 'seasons')">Seasons</button>
    <button data-tab="tournaments" onclick="showTab('prefs', 'tournaments')">Tournaments</button>
    <button data-tab="utilities" onclick="showTab('prefs', 'utilities')">Utilities</button>
</div>

<!-- ── Seasons Tab ─────────────────────────────────────────────────────── -->
<div id="prefs-seasons" class="tab-content active" data-group="prefs">
    <div class="card">
        <div style="display: flex; gap: 1.25rem; min-height: 350px;">

            <!-- Left: Season list -->
            <div style="flex: 1; border-right: 1px solid var(--border); padding-right: 1.25rem;">
                <h2 style="margin-bottom: 0.75rem;">Seasons</h2>
                <div id="season-list" style="display: flex; flex-direction: column; gap: 2px;">
                    {% if seasons %}
                        {% for season in seasons %}
                        <div class="season-item {% if loop.first %}selected{% endif %}"
                             data-season-id="{{ season.id }}"
                             onclick="selectSeason(this, {{ season.id }})">
                            <div style="font-weight: 600;">{{ season.name }}</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">{{ season.rules | replace('_', ' ') | upper }} &mdash; {{ season.gender | capitalize }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: var(--text-light); font-size: 0.9rem;">No seasons yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Right: Action buttons -->
            <div style="display: flex; flex-direction: column; gap: 0.5rem; padding-top: 2.5rem; min-width: 100px;">
                <button class="btn" onclick="showAddSeason()">Add</button>
                <button class="btn" onclick="showEditSeason()" id="btn-edit-season" {% if not seasons %}disabled{% endif %}>Edit</button>
                <button class="btn" style="background: var(--error);" onclick="deleteSeason()" id="btn-delete-season" {% if not seasons %}disabled{% endif %}>Delete</button>
            </div>
        </div>
    </div>

    <!-- Delete Season forms (hidden) -->
    {% for season in seasons %}
    <form id="delete-season-{{ season.id }}" method="post" action="{{ url_for('main.configure_season_delete', season_id=season.id) }}" style="display: none;"></form>
    {% endfor %}
</div>

<!-- ── New Season Modal ────────────────────────────────────────────────── -->
<div id="add-season-modal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
        <h2>New Season</h2>
        <form method="post" action="{{ url_for('main.configure_season_create') }}">
            <div class="form-group">
                <label for="season-name">Season Title:</label>
                <input type="text" id="season-name" name="name" required placeholder="e.g. Spring 2025 Softball">
            </div>
            <div class="form-group">
                <label for="season-play-entry">Default Play Entry Mode:</label>
                <select id="season-play-entry" name="play_entry_mode" required>
                    <option value="" disabled selected></option>
                    <option value="box_game_totals">Box Score: Game Totals</option>
                    <option value="box_inning_by_inning">Box Score: Inning by Inning</option>
                    <option value="pbp_simple">Play-by-Play: Simple Mode</option>
                </select>
            </div>
            <div class="form-group">
                <label for="season-rules">Rules:</label>
                <select id="season-rules" name="rules" required>
                    <option value="" disabled selected></option>
                    <option value="rules_hs_ba">High School Baseball</option>
                    <option value="rules_hs_sb">High School Softball</option>
                    <option value="rules_ncaa_ba">NCAA Baseball</option>
                    <option value="rules_ncaa_sb">NCAA Softball</option>
                    <option value="rules_mlb">Major League Baseball</option>
                </select>
            </div>
            <div class="form-group">
                <label for="season-gender">Default Gender:</label>
                <select id="season-gender" name="gender" required>
                    <option value="" disabled selected></option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="submit" class="btn">OK</button>
                <button type="button" class="btn" style="background: var(--text-light);" onclick="hideModals()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- ── Edit Season Modal ───────────────────────────────────────────────── -->
{% for season in seasons %}
<div id="edit-season-modal-{{ season.id }}" class="modal-overlay edit-season-modal" style="display: none;">
    <div class="modal-box">
        <h2>Edit Season</h2>
        <form method="post" action="{{ url_for('main.configure_season_edit', season_id=season.id) }}">
            <div class="form-group">
                <label>Season Title:</label>
                <input type="text" name="name" value="{{ season.name }}" required>
            </div>
            <div class="form-group">
                <label>Default Play Entry Mode:</label>
                <select name="play_entry_mode">
                    <option value="box_game_totals" {{ 'selected' if season.play_entry_mode == 'box_game_totals' }}>Box Score: Game Totals</option>
                    <option value="box_inning_by_inning" {{ 'selected' if season.play_entry_mode == 'box_inning_by_inning' }}>Box Score: Inning by Inning</option>
                    <option value="pbp_simple" {{ 'selected' if season.play_entry_mode == 'pbp_simple' }}>Play-by-Play: Simple Mode</option>
                </select>
            </div>
            <div class="form-group">
                <label>Rules:</label>
                <select name="rules">
                    <option value="rules_hs_ba" {{ 'selected' if season.rules == 'rules_hs_ba' }}>High School Baseball</option>
                    <option value="rules_hs_sb" {{ 'selected' if season.rules == 'rules_hs_sb' }}>High School Softball</option>
                    <option value="rules_ncaa_ba" {{ 'selected' if season.rules == 'rules_ncaa_ba' }}>NCAA Baseball</option>
                    <option value="rules_ncaa_sb" {{ 'selected' if season.rules == 'rules_ncaa_sb' }}>NCAA Softball</option>
                    <option value="rules_mlb" {{ 'selected' if season.rules == 'rules_mlb' }}>Major League Baseball</option>
                </select>
            </div>
            <div class="form-group">
                <label>Default Gender:</label>
                <select name="gender">
                    <option value="male" {{ 'selected' if season.gender == 'male' }}>Male</option>
                    <option value="female" {{ 'selected' if season.gender == 'female' }}>Female</option>
                </select>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="submit" class="btn accent">Save</button>
                <button type="button" class="btn" style="background: var(--text-light);" onclick="hideModals()">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

<!-- ── Tournaments Tab ─────────────────────────────────────────────────── -->
<div id="prefs-tournaments" class="tab-content" data-group="prefs">
    <div class="card">
        <h2>Tournaments</h2>
        <p style="color: var(--text-light);">Tournament configuration coming soon.</p>
    </div>
</div>

<!-- ── Utilities Tab ───────────────────────────────────────────────────── -->
<div id="prefs-utilities" class="tab-content" data-group="prefs">
    <div class="card">
        <h2>Utilities</h2>
        <p style="color: var(--text-light);">Database utilities coming soon.</p>
    </div>
</div>

<div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.25rem;">
    <a href="{{ url_for('main.index') }}" class="btn">OK</a>
    <a href="{{ url_for('main.index') }}" class="btn" style="background: var(--text-light);">Cancel</a>
</div>

{% endblock %}

{% block scripts %}
<style>
    .season-item {
        padding: 0.6rem 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.15s;
    }
    .season-item:hover {
        background: #edf2f7;
    }
    .season-item.selected {
        background: var(--primary);
        color: white;
    }
    .season-item.selected div {
        color: white !important;
    }
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .modal-box {
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.2);
        padding: 1.5rem;
        width: 420px;
        max-width: 90vw;
    }
    .modal-box h2 {
        margin-bottom: 1rem;
    }
    .modal-box .form-group {
        margin-bottom: 0.75rem;
    }
</style>
<script>
var selectedSeasonId = {{ seasons[0].id if seasons else 'null' }};

function selectSeason(el, id) {
    document.querySelectorAll('.season-item').forEach(function(item) {
        item.classList.remove('selected');
    });
    el.classList.add('selected');
    selectedSeasonId = id;
}

function hideModals() {
    document.getElementById('add-season-modal').style.display = 'none';
    document.querySelectorAll('.edit-season-modal').forEach(function(el) {
        el.style.display = 'none';
    });
}

function showAddSeason() {
    hideModals();
    document.getElementById('add-season-modal').style.display = '';
    document.getElementById('season-name').focus();
}

function showEditSeason() {
    if (!selectedSeasonId) return;
    hideModals();
    var modal = document.getElementById('edit-season-modal-' + selectedSeasonId);
    if (modal) {
        modal.style.display = '';
    }
}

function deleteSeason() {
    if (!selectedSeasonId) return;
    if (confirm('Delete this season and all its teams?')) {
        var form = document.getElementById('delete-season-' + selectedSeasonId);
        if (form) form.submit();
    }
}

// Close modal on overlay click
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay')) {
        hideModals();
    }
});
</script>
{% endblock %}
